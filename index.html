<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Rubrox Mining App</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #111, #400040);
      color: white;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(255, 0, 150, 0.4);
      position: relative;
      width: 100%;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #ffd700;
    }
    h2 {
      font-size: 1.4rem;
      margin: 20px 0 10px;
      color: #ff8c00;
    }
    input[type="text"], input[type="number"], input[type="email"], input[type="tel"], select {
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 8px;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 16px;
    }
    input::placeholder {
      color: #ccc;
    }
    button {
      background: #ff0080;
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 0;
      width: 100%;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 0, 128, 0.4);
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    button.secondary {
      background: #333;
    }
    .rubies {
      font-size: 2.2rem;
      margin: 20px 0;
      color: #ffd700;
      font-weight: bold;
    }
    .info {
      font-size: 0.9rem;
      color: #ccc;
      margin: 8px 0;
    }
    .success {
      color: #4CAF50;
    }
    .warning {
      color: #FFC107;
    }
    .error {
      color: #F44336;
    }
    #logoutBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 14px;
      width: auto;
    }
    #notification {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, #ff0080, #ff8c00);
      color: white;
      padding: 15px;
      font-weight: bold;
      z-index: 1000;
      transform: translateY(-100%);
      transition: transform 0.3s ease-out;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #notification.show {
      transform: translateY(0);
    }
    .ban-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: black;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
    }
    .ban-screen h2 {
      color: red;
      font-size: 2rem;
      margin-bottom: 20px;
    }
    .ban-screen p {
      font-size: 1.2rem;
      margin-bottom: 30px;
      color: white;
    }
    .ban-screen button {
      background: red;
      max-width: 200px;
    }
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      margin: 5px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }
    .leaderboard-rank {
      font-weight: bold;
      color: #ffd700;
    }
    .leaderboard-name {
      flex-grow: 1;
      text-align: left;
      padding-left: 15px;
    }
    .leaderboard-rubies {
      font-weight: bold;
    }
    .progress-container {
      width: 100%;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      margin: 15px 0;
      height: 10px;
    }
    .progress-bar {
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(90deg, #ff0080, #ff8c00);
      transition: width 0.3s;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1500;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal-content {
      background: linear-gradient(135deg, #222, #500050);
      padding: 20px;
      border-radius: 15px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close-modal {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .tab-container {
      display: flex;
      margin-bottom: 15px;
    }
    .tab {
      flex: 1;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      border-bottom: 3px solid #ff0080;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .referral-link {
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      word-break: break-all;
    }
    .referral-stats {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
    }
    .stat-box {
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
      flex: 1;
      margin: 0 5px;
    }
    .withdrawal-item {
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
      margin: 5px 0;
      text-align: left;
    }
    .withdrawal-status {
      float: right;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8rem;
    }
    .status-pending {
      background: #FFC107;
      color: black;
    }
    .status-approved {
      background: #4CAF50;
      color: white;
    }
    .status-rejected {
      background: #F44336;
      color: white;
    }
    .kyc-form {
      text-align: left;
    }
    .kyc-upload {
      border: 2px dashed rgba(255,255,255,0.3);
      padding: 20px;
      text-align: center;
      margin: 10px 0;
      border-radius: 8px;
      cursor: pointer;
    }
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      h1 {
        font-size: 1.5rem;
      }
      h2 {
        font-size: 1.2rem;
      }
      button {
        padding: 12px 20px;
      }
      .rubies {
        font-size: 1.8rem;
      }
      .stat-box {
        padding: 8px 5px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div id="notification">New notification!</div>

  <div class="container">
    <button id="logoutBtn" onclick="logout()" style="display:none;">Logout</button>
    <h1>üíé Rubrox Miner</h1>
    <div id="authSection">
      <p>Enter Your Name:</p>
      <input type="text" id="usernameInput" placeholder="Your Name" />
      <input type="text" id="referralInput" placeholder="Referral Code (optional)" />
      <br />
      <button onclick="login()">Start Mining</button>
      <p class="info">By registering, you agree to our <a href="#" onclick="showTerms()" style="color:#ff8c00;">Terms of Service</a></p>
    </div>

    <div id="mainApp" style="display:none;">
      <p>üëã Welcome, <span id="userName" style="color:#ff8c00;font-weight:bold;"></span></p>
      <p class="rubies">üíé <span id="rubyCount">0</span> </p>
      <p>üìÖ Mining Days: <span id="miningDays">0</span></p>
      <p class="info" id="miningStatus"></p>
      <div class="progress-container" id="progressContainer" style="display:none;">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <button id="mineBtn" onclick="startMining()">‚õèÔ∏è Start 24h Mining</button>
      <button onclick="claimBonus()" id="bonusBtn">üéÅ Claim Daily Bonus</button>
      <p class="info" id="bonusStatus"></p>
      <p class="info" id="kycStatus"></p>
      <button onclick="requestWithdraw()" id="withdrawBtn" disabled>üíµ Request Withdraw</button>
      
      <div class="tab-container">
        <div class="tab active" onclick="switchTab('leaderboard')">üèÜ Leaderboard</div>
        <div class="tab" onclick="switchTab('referrals')">üë• Referrals</div>
        <div class="tab" onclick="switchTab('withdrawals')">üí∏ Withdrawals</div>
      </div>
      
      <div id="leaderboard" class="tab-content active"></div>
      
      <div id="referrals" class="tab-content">
        <h3>Your Referral Link</h3>
        <div class="referral-link" id="referralLink">Loading...</div>
        <button onclick="copyReferralLink()">üìã Copy Link</button>
        
        <div class="referral-stats">
          <div class="stat-box">
            <div>Total Referrals</div>
            <div id="totalReferrals">0</div>
          </div>
          <div class="stat-box">
            <div>Earned from Referrals</div>
            <div id="referralEarnings">0 üíé</div>
          </div>
        </div>
        
        <h3>Your Referrals</h3>
        <div id="referralList"></div>
      </div>
      
      <div id="withdrawals" class="tab-content">
        <h3>Withdrawal History</h3>
        <div id="withdrawalHistory"></div>
      </div>
    </div>
  </div>

  <div id="banScreen" class="ban-screen" style="display:none;">
    <h2>ACCOUNT BANNED</h2>
    <p>Your account has been suspended by the administrator.</p>
    <p>Please contact support if you believe this is a mistake.</p>
    <button onclick="logout()">Return to Login</button>
  </div>

  <!-- KYC Verification Modal -->
  <div id="kycModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('kycModal')">&times;</span>
      <h2>KYC Verification</h2>
      <p>To withdraw your rubies, please complete KYC verification by providing the following information:</p>
      
      <div class="kyc-form">
        <label>Full Name</label>
        <input type="text" id="kycName" placeholder="As per your ID">
        
        <label>Date of Birth</label>
        <input type="date" id="kycDob">
        
        <label>ID Type</label>
        <select id="kycIdType">
          <option value="passport">Passport</option>
          <option value="driver_license">Driver's License</option>
          <option value="national_id">National ID</option>
        </select>
        
        <label>ID Number</label>
        <input type="text" id="kycIdNumber" placeholder="ID document number">
        
        <label>ID Photo (Front)</label>
        <div class="kyc-upload" onclick="document.getElementById('kycFront').click()">
          <p>Click to upload ID Front</p>
          <input type="file" id="kycFront" accept="image/*" style="display:none;" onchange="previewImage(this, 'kycFrontPreview')">
          <img id="kycFrontPreview" style="max-width:100%; max-height:150px; display:none;">
        </div>
        
        <label>ID Photo (Back)</label>
        <div class="kyc-upload" onclick="document.getElementById('kycBack').click()">
          <p>Click to upload ID Back</p>
          <input type="file" id="kycBack" accept="image/*" style="display:none;" onchange="previewImage(this, 'kycBackPreview')">
          <img id="kycBackPreview" style="max-width:100%; max-height:150px; display:none;">
        </div>
        
        <label>Selfie with ID</label>
        <div class="kyc-upload" onclick="document.getElementById('kycSelfie').click()">
          <p>Click to upload Selfie with ID</p>
          <input type="file" id="kycSelfie" accept="image/*" style="display:none;" onchange="previewImage(this, 'kycSelfiePreview')">
          <img id="kycSelfiePreview" style="max-width:100%; max-height:150px; display:none;">
        </div>
        
        <button onclick="submitKYC()">Submit Verification</button>
      </div>
    </div>
  </div>

  <!-- Terms Modal -->
  <div id="termsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('termsModal')">&times;</span>
      <h2>Terms of Service</h2>
      <div style="text-align:left; max-height:60vh; overflow-y:auto;">
        <h3>1. Account Terms</h3>
        <p>You must be at least 18 years old to use this service. You are responsible for maintaining the security of your account.</p>
        
        <h3>2. Mining Rules</h3>
        <p>Each mining session lasts 24 hours. You can only have one active mining session at a time. The mining rate is approximately 0.0002 rubies every 5 seconds.</p>
        
        <h3>3. Referral Program</h3>
        <p>You earn 5 rubies for each successful referral, and your referral earns 10 rubies. Referral bonuses are awarded only when the referred user completes their first mining session.</p>
        
        <h3>4. Withdrawals</h3>
        <p>Withdrawals require KYC verification after 30 days of mining. Withdrawal requests are processed within 3-5 business days. There may be minimum withdrawal amounts.</p>
        
        <h3>5. Prohibited Activities</h3>
        <p>The following activities are prohibited and may result in account suspension:</p>
        <ul>
          <li>Creating multiple accounts</li>
          <li>Using automated scripts or bots</li>
          <li>Attempting to exploit system vulnerabilities</li>
          <li>Providing false information during KYC</li>
        </ul>
        
        <h3>6. Liability</h3>
        <p>We are not responsible for any losses resulting from unauthorized access to your account. Ruby values may fluctuate.</p>
      </div>
      <button onclick="closeModal('termsModal')">I Understand</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDX7Z8o5xVJa8cSHvaurZg4FkJvN8mJuto",
      authDomain: "free-fire-kingdom.firebaseapp.com",
      databaseURL: "https://free-fire-kingdom-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "free-fire-kingdom",
      storageBucket: "free-fire-kingdom.appspot.com",
      messagingSenderId: "889375613179",
      appId: "1:889375613179:web:b36bd72dd208b101e0d05e",
      measurementId: "G-0EWSZ3SFX1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "";
    let miningInterval;
    let progressInterval;
    let referralLink = "";

    function showNotification(message) {
      const notif = document.getElementById("notification");
      notif.textContent = message;
      notif.classList.add("show");
      setTimeout(() => {
        notif.classList.remove("show");
      }, 5000);
    }

    function showModal(modalId) {
      document.getElementById(modalId).style.display = "flex";
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    function showTerms() {
      showModal('termsModal');
    }

    function switchTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Deactivate all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Activate selected tab
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
      
      // Load data if needed
      if(tabId === 'referrals') {
        loadReferralData();
      } else if(tabId === 'withdrawals') {
        loadWithdrawalHistory();
      }
    }

    function login() {
      const name = document.getElementById("usernameInput").value.trim();
      const refCode = document.getElementById("referralInput").value.trim();
      if (!name) return showNotification("Please enter your name");
      currentUser = name;
      const userRef = db.ref("users/" + currentUser);

      userRef.once("value", (snap) => {
        if (!snap.exists()) {
          userRef.set({ 
            rubies: 0, 
            referral: refCode || "", 
            miningDays: 0, 
            lastBonus: "", 
            miningEnd: 0, 
            kyc: false, 
            kycRequested: false, 
            banned: false,
            totalReferrals: 0,
            referralEarnings: 0,
            joinDate: new Date().toISOString()
          });
          if (refCode) {
            // Give referral bonus after first mining session
            db.ref("users/" + refCode + "/totalReferrals").transaction(val => (val || 0) + 1);
            showNotification("üéâ Referral link applied! Bonus will be awarded after your first mining session.");
          }
        } else {
          if (refCode && !snap.val().referral) {
            userRef.update({ referral: refCode });
            db.ref("users/" + refCode + "/totalReferrals").transaction(val => (val || 0) + 1);
            showNotification("üéâ Referral link applied! Bonus will be awarded after your first mining session.");
          }
        }
        loadUser();
      });
    }

    function loadUser() {
      document.getElementById("authSection").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      document.getElementById("logoutBtn").style.display = "block";
      document.getElementById("userName").innerText = currentUser;

      const ref = db.ref("users/" + currentUser);
      ref.on("value", snap => {
        const data = snap.val();
        if(!data) return;

        if(data.banned) {
          showBanScreen();
          return;
        }

        document.getElementById("rubyCount").innerText = Number(data.rubies).toFixed(4);
        document.getElementById("miningDays").innerText = data.miningDays || 0;

        // Generate referral link
        referralLink = window.location.href.split('?')[0] + '?ref=' + currentUser;
        document.getElementById("referralLink").textContent = referralLink;

        const now = Date.now();
        const today = new Date().toISOString().slice(0, 10);

        // Check if bonus already claimed today
        if (data.lastBonus === today) {
          document.getElementById("bonusStatus").innerText = "üéÅ Daily bonus already claimed! Come back tomorrow.";
          document.getElementById("bonusBtn").disabled = true;
        } else {
          document.getElementById("bonusStatus").innerText = "üéÅ Daily bonus available!";
          document.getElementById("bonusBtn").disabled = false;
        }

        if (data.miningEnd && data.miningEnd > now) {
          document.getElementById("mineBtn").disabled = true;
          document.getElementById("progressContainer").style.display = "block";
          const remaining = data.miningEnd - now;
          updateProgressBar(remaining);
          document.getElementById("miningStatus").innerText = "‚õèÔ∏è Mining active - " + formatTime(remaining);
          startMiningInterval(data.miningEnd);
          startProgressInterval(data.miningEnd);
        } else {
          document.getElementById("mineBtn").disabled = false;
          document.getElementById("progressContainer").style.display = "none";
          document.getElementById("miningStatus").innerText = "üïí Ready to start mining";
          if (miningInterval) {
            clearInterval(miningInterval);
          }
          if (progressInterval) {
            clearInterval(progressInterval);
          }
        }

        if (data.kycRequested) {
          document.getElementById("kycStatus").innerHTML = data.kyc ? 
            '<span class="success">‚úÖ KYC Verified</span>' : 
            '<span class="warning">‚åõ KYC Pending (admin approval required)</span>';
        } else if (data.miningDays >= 30) {
          document.getElementById("kycStatus").innerHTML = 
            '<span class="success">üéâ You\'re eligible for KYC verification! <a href="#" onclick="showModal(\'kycModal\')" style="color:#ff8c00;">Click here</a> to verify</span>';
        } else {
          const daysLeft = 30 - (data.miningDays || 0);
          document.getElementById("kycStatus").innerHTML = 
            `<span class="info">üìÜ ${daysLeft} more mining days to unlock KYC</span>`;
        }

        document.getElementById("withdrawBtn").disabled = !data.kyc;
      });

      loadLeaderboard();
    }

    function showBanScreen() {
      document.getElementById("banScreen").style.display = "flex";
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("authSection").style.display = "none";
    }

    function formatTime(ms) {
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);
      return `${hours}h ${minutes}m ${seconds}s remaining`;
    }

    function updateProgressBar(remaining) {
      const total = 24 * 60 * 60 * 1000;
      const percentage = 100 - (remaining / total * 100);
      document.getElementById("progressBar").style.width = `${percentage}%`;
    }

    function startProgressInterval(endTime) {
      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now;
        if (remaining <= 0) {
          clearInterval(progressInterval);
          document.getElementById("progressContainer").style.display = "none";
          return;
        }
        updateProgressBar(remaining);
        document.getElementById("miningStatus").innerText = "‚õèÔ∏è Mining active - " + formatTime(remaining);
      }, 1000);
    }

    function startMiningInterval(endTime) {
      if (miningInterval) clearInterval(miningInterval);
      miningInterval = setInterval(() => {
        const now = Date.now();
        if (now >= endTime) {
          clearInterval(miningInterval);
          document.getElementById("mineBtn").disabled = false;
          document.getElementById("progressContainer").style.display = "none";
          document.getElementById("miningStatus").innerText = "‚úÖ Mining finished! Start again to earn more";
          showNotification("‚õèÔ∏è Your mining session has completed!");
          
          // Award referral bonus if this was first mining session
          const userRef = db.ref("users/" + currentUser);
          userRef.once("value").then(snap => {
            const data = snap.val();
            if (data.referral && data.miningDays === 1) { // First mining session completed
              // Give bonus to referrer
              db.ref("users/" + data.referral + "/rubies").transaction(val => (val || 0) + 10);
              db.ref("users/" + data.referral + "/referralEarnings").transaction(val => (val || 0) + 10);
              // Give bonus to new user
              userRef.child("rubies").transaction(val => (val || 0) + 5);
              showNotification("üéâ Referral bonus awarded! +5 Rubies for you and +10 for your referrer");
            }
          });
          return;
        }
        db.ref("users/" + currentUser + "/rubies").transaction(rubies => (rubies || 0) + 0.0002);
      }, 5000);
    }

    function startMining() {
      const now = Date.now();
      const end = now + 24 * 60 * 60 * 1000;
      const userRef = db.ref("users/" + currentUser);

      userRef.once("value").then(snap => {
        const data = snap.val();
        if (!data.miningEnd || data.miningEnd < now) {
          userRef.update({
            miningEnd: end,
            miningDays: (data.miningDays || 0) + 1
          });
          startMiningInterval(end);
          startProgressInterval(end);
          document.getElementById("mineBtn").disabled = true;
          document.getElementById("progressContainer").style.display = "block";
          document.getElementById("miningStatus").innerText = "‚õèÔ∏è Mining active - " + formatTime(24 * 60 * 60 * 1000);
          showNotification("‚õèÔ∏è Mining started for 24 hours!");
        } else {
          showNotification("Mining is already active");
        }
      });
    }

    function claimBonus() {
      const today = new Date().toISOString().slice(0, 10);
      const userRef = db.ref("users/" + currentUser);
      userRef.once("value").then(snap => {
        const data = snap.val();
        if (data.lastBonus === today) {
          document.getElementById("bonusStatus").innerText = "üéÅ Daily bonus already claimed!";
          showNotification("You've already claimed your daily bonus today");
        } else {
          userRef.update({
            rubies: (data.rubies || 0) + 20,
            lastBonus: today
          });
          document.getElementById("bonusStatus").innerText = "‚úÖ Daily bonus claimed! +20 Rubies";
          document.getElementById("bonusBtn").disabled = true;
          showNotification("üéÅ Daily bonus claimed! +20 Rubies");
        }
      });
    }

    function requestWithdraw() {
      const userRef = db.ref("users/" + currentUser);
      userRef.once("value").then(snap => {
        const data = snap.val();
        const balance = data.rubies || 0;
        
        const amount = prompt(`Enter withdraw amount (Available: ${balance.toFixed(4)} Rubies, Minimum: 100 Rubies):`);
        if (!amount || isNaN(amount)) return showNotification("Invalid amount");
        
        if (parseFloat(amount) > balance) {
          return showNotification("Insufficient balance");
        }
        
        if (parseFloat(amount) < 100) {
          return showNotification("Minimum withdrawal amount is 100 Rubies");
        }
        
        const contact = prompt("Enter contact info (e.g., phone number or email):");
        if (!contact) return showNotification("Contact info required");
        
        const reqRef = db.ref("withdrawals").push();
        reqRef.set({
          user: currentUser,
          amount: parseFloat(amount),
          contact: contact,
          status: "pending",
          timestamp: Date.now(),
          processed: false
        });
        
        // Deduct from balance
        userRef.child("rubies").transaction(rubies => (rubies || 0) - parseFloat(amount));
        
        showNotification("‚úÖ Withdrawal request submitted! Processing may take 3-5 business days.");
      });
    }

    function loadLeaderboard() {
      db.ref("users").orderByChild("rubies").limitToLast(10).on("value", snap => {
        const list = [];
        snap.forEach(child => {
          const d = child.val();
          if(d.banned) return;
          list.push({ name: child.key, rubies: d.rubies || 0 });
        });
        
        // Reverse to show highest first
        list.reverse();
        const leaderboard = document.getElementById("leaderboard");
        leaderboard.innerHTML = "";
        
        list.forEach((u, index) => {
          const item = document.createElement("div");
          item.className = "leaderboard-item";
          
          const rank = document.createElement("span");
          rank.className = "leaderboard-rank";
          rank.textContent = `#${index + 1}`;
          
          const name = document.createElement("span");
          name.className = "leaderboard-name";
          name.textContent = u.name;
          
          const rubies = document.createElement("span");
          rubies.className = "leaderboard-rubies";
          rubies.textContent = `${u.rubies.toFixed(4)} üíé`;
          
          item.appendChild(rank);
          item.appendChild(name);
          item.appendChild(rubies);
          leaderboard.appendChild(item);
        });
      });
    }

    function loadReferralData() {
      // Load referral stats
      db.ref("users/" + currentUser).once("value").then(snap => {
        const data = snap.val();
        document.getElementById("totalReferrals").textContent = data.totalReferrals || 0;
        document.getElementById("referralEarnings").textContent = (data.referralEarnings || 0) + " üíé";
      });
      
      // Load referral list
      db.ref("users").orderByChild("referral").equalTo(currentUser).once("value").then(snap => {
        const referralList = document.getElementById("referralList");
        referralList.innerHTML = "";
        
        if (!snap.exists()) {
          referralList.innerHTML = "<p>No referrals yet</p>";
          return;
        }
        
        snap.forEach(child => {
          const item = document.createElement("div");
          item.className = "leaderboard-item";
          item.innerHTML = `
            <span>${child.key}</span>
            <span>Joined: ${new Date(child.val().joinDate).toLocaleDateString()}</span>
          `;
          referralList.appendChild(item);
        });
      });
    }

    function loadWithdrawalHistory() {
      db.ref("withdrawals").orderByChild("user").equalTo(currentUser).once("value").then(snap => {
        const history = document.getElementById("withdrawalHistory");
        history.innerHTML = "";
        
        if (!snap.exists()) {
          history.innerHTML = "<p>No withdrawal history</p>";
          return;
        }
        
        const withdrawals = [];
        snap.forEach(child => {
          withdrawals.push({
            key: child.key,
            ...child.val()
          });
        });
        
        // Sort by timestamp (newest first)
        withdrawals.sort((a, b) => b.timestamp - a.timestamp);
        
        withdrawals.forEach(w => {
          const item = document.createElement("div");
          item.className = "withdrawal-item";
          item.innerHTML = `
            <div>Amount: ${w.amount.toFixed(4)} üíé</div>
            <div>Date: ${new Date(w.timestamp).toLocaleString()}</div>
            <div>Status: <span class="withdrawal-status status-${w.status}">${w.status.toUpperCase()}</span></div>
          `;
          history.appendChild(item);
        });
      });
    }

    function copyReferralLink() {
      navigator.clipboard.writeText(referralLink).then(() => {
        showNotification("Referral link copied to clipboard!");
      }).catch(err => {
        console.error("Failed to copy: ", err);
        showNotification("Failed to copy link");
      });
    }

    function previewImage(input, previewId) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById(previewId);
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    }

    function submitKYC() {
      const name = document.getElementById("kycName").value.trim();
      const dob = document.getElementById("kycDob").value;
      const idType = document.getElementById("kycIdType").value;
      const idNumber = document.getElementById("kycIdNumber").value.trim();
      
      if (!name || !dob || !idNumber) {
        return showNotification("Please fill all required fields");
      }
      
      // In a real app, you would upload the images to storage and save the URLs
      // For this demo, we'll just simulate it
      
      const userRef = db.ref("users/" + currentUser);
      userRef.update({
        kycRequested: true,
        kycData: {
          name: name,
          dob: dob,
          idType: idType,
          idNumber: idNumber,
          submittedAt: new Date().toISOString()
        }
      });
      
      // Also add to admin queue for approval
      db.ref("kycSubmissions").push().set({
        user: currentUser,
        submittedAt: new Date().toISOString(),
        status: "pending"
      });
      
      showNotification("‚úÖ KYC submitted for review! Please wait for admin approval.");
      closeModal('kycModal');
    }

    // Check for referral code on page load
    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const refCode = urlParams.get('ref');
      if (refCode) {
        document.getElementById("referralInput").value = refCode;
      }
      
      // Global notifications
      db.ref("notifications").limitToLast(1).on("child_added", snap => {
        const notif = snap.val();
        showNotification("üîî " + notif.message);
      });
    };

    function logout() {
      if(miningInterval) clearInterval(miningInterval);
      if(progressInterval) clearInterval(progressInterval);
      currentUser = "";
      document.getElementById("authSection").style.display = "block";
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("banScreen").style.display = "none";
      document.getElementById("usernameInput").value = "";
      document.getElementById("referralInput").value = "";
      document.getElementById("bonusStatus").innerText = "";
      document.getElementById("kycStatus").innerText = "";
      document.getElementById("miningStatus").innerText = "";
      document.getElementById("progressContainer").style.display = "none";
    }
  </script>
</body>
</html>
