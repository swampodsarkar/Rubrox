<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Rubrox Mining App</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff0080;
      --secondary: #ff8c00;
      --accent: #ffd700;
      --dark: #111;
      --darker: #0a0a0a;
      --light: #fff;
      --gray: #ccc;
      --success: #4CAF50;
      --warning: #FFC107;
      --error: #F44336;
      --card-bg: rgba(255, 255, 255, 0.05);
      --card-shadow: 0 0 20px rgba(255, 0, 150, 0.4);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--darker), #400040);
      color: var(--light);
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      position: relative;
      width: 100%;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: var(--accent);
      text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    h2 {
      font-size: 1.4rem;
      margin: 20px 0 10px;
      color: var(--secondary);
    }
    
    input[type="text"], input[type="number"], input[type="email"], input[type="tel"], select, textarea {
      padding: 12px 15px;
      width: 100%;
      border: none;
      border-radius: 8px;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.1);
      color: var(--light);
      font-size: 16px;
      transition: all 0.3s;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(255, 0, 128, 0.3);
    }
    
    input::placeholder {
      color: var(--gray);
    }
    
    button {
      background: var(--primary);
      color: white;
      padding: 14px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 0;
      width: 100%;
      font-weight: bold;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 0, 128, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    
    button.secondary {
      background: #333;
    }
    
    .rubies {
      font-size: 2.2rem;
      margin: 20px 0;
      color: var(--accent);
      font-weight: bold;
      text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .info {
      font-size: 0.9rem;
      color: var(--gray);
      margin: 8px 0;
    }
    
    .success {
      color: var(--success);
    }
    
    .warning {
      color: var(--warning);
    }
    
    .error {
      color: var(--error);
    }
    
    #logoutBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--error);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 14px;
      width: auto;
    }
    
    #notification {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px;
      font-weight: bold;
      z-index: 1000;
      transform: translateY(-100%);
      transition: transform 0.3s ease-out;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #notification.show {
      transform: translateY(0);
    }
    
    .ban-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--dark);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><pattern id="pattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="40" height="40" fill="black"/><path d="M0,0 L40,40" stroke="red" stroke-width="1"/><path d="M40,0 L0,40" stroke="red" stroke-width="1"/></pattern><rect x="0" y="0" width="100%" height="100%" fill="url(%23pattern)" opacity="0.3"/></svg>');
    }
    
    .ban-screen h2 {
      color: var(--error);
      font-size: 2rem;
      margin-bottom: 20px;
    }
    
    .ban-screen p {
      font-size: 1.2rem;
      margin-bottom: 30px;
      color: white;
    }
    
    .ban-screen button {
      background: var(--error);
      max-width: 200px;
    }
    
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      margin: 8px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      align-items: center;
      transition: all 0.3s;
    }
    
    .leaderboard-item:hover {
      transform: translateX(5px);
      background: rgba(255,255,255,0.15);
    }
    
    .leaderboard-rank {
      font-weight: bold;
      color: var(--accent);
      min-width: 30px;
      text-align: center;
    }
    
    .leaderboard-name {
      flex-grow: 1;
      text-align: left;
      padding-left: 15px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .leaderboard-rubies {
      font-weight: bold;
      min-width: 100px;
      text-align: right;
    }
    
    .progress-container {
      width: 100%;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      margin: 15px 0;
      height: 10px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.3s;
      position: relative;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.3) 50%, 
        rgba(255,255,255,0) 100%);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1500;
      justify-content: center;
      align-items: center;
      padding: 20px;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background: linear-gradient(135deg, #222, #500050);
      padding: 20px;
      border-radius: 15px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .close-modal {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
      padding: 5px;
      border-radius: 50%;
    }
    
    .close-modal:hover {
      background: rgba(255,255,255,0.1);
      transform: rotate(90deg);
    }
    
    .tab-container {
      display: flex;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      position: relative;
    }
    
    .tab.active {
      font-weight: bold;
      background: rgba(255,255,255,0.2);
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .referral-link {
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      word-break: break-all;
      font-family: monospace;
      position: relative;
    }
    
    .referral-link::after {
      content: 'üìã';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.3s;
    }
    
    .referral-link:hover::after {
      opacity: 1;
      transform: translateY(-50%) scale(1.1);
    }
    
    .referral-stats {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      gap: 10px;
    }
    
    .stat-box {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      flex: 1;
      transition: all 0.3s;
    }
    
    .stat-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .stat-box div:first-child {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 5px;
    }
    
    .stat-box div:last-child {
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .withdrawal-item {
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      text-align: left;
      transition: all 0.3s;
    }
    
    .withdrawal-item:hover {
      transform: translateX(5px);
      background: rgba(255,255,255,0.15);
    }
    
    .withdrawal-status {
      float: right;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .status-pending {
      background: var(--warning);
      color: black;
    }
    
    .status-approved {
      background: var(--success);
      color: white;
    }
    
    .status-rejected {
      background: var(--error);
      color: white;
    }
    
    .kyc-form {
      text-align: left;
    }
    
    .kyc-upload {
      border: 2px dashed rgba(255,255,255,0.3);
      padding: 20px;
      text-align: center;
      margin: 10px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .kyc-upload:hover {
      border-color: var(--primary);
      background: rgba(255,255,255,0.05);
    }
    
    .kyc-upload input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    .kyc-upload img {
      max-width: 100%;
      max-height: 150px;
      display: none;
      margin-top: 10px;
      border-radius: 5px;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }
    
    .profile-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      margin-right: 15px;
    }
    
    .profile-info {
      text-align: left;
      flex-grow: 1;
    }
    
    .profile-name {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .profile-level {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 15px 0;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
      margin: 5px 0;
    }
    
    .stat-card .stat-label {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .badge-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
    }
    
    .badge {
      background: rgba(255,255,255,0.1);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .badge i {
      color: var(--accent);
    }
    
    .mining-animation {
      position: relative;
      height: 80px;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .pickaxe {
      position: absolute;
      font-size: 2rem;
      animation: mine 1.5s infinite ease-in-out;
      transform-origin: bottom right;
    }
    
    @keyframes mine {
      0%, 100% { transform: rotate(-10deg); }
      50% { transform: rotate(10deg); }
    }
    
    .rock {
      position: absolute;
      font-size: 3rem;
      animation: shake 1.5s infinite;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      75% { transform: translateX(3px); }
    }
    
    .sparkle {
      position: absolute;
      font-size: 1rem;
      color: var(--accent);
      opacity: 0;
      animation: sparkle 1.5s infinite;
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1); }
    }
    
    .settings-item {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      margin: 8px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      align-items: center;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    .dark-mode {
      --dark: #0a0a0a;
      --darker: #000;
      --light: #f0f0f0;
      --card-bg: rgba(255, 255, 255, 0.05);
    }
    
    .light-mode {
      --dark: #f5f5f5;
      --darker: #e0e0e0;
      --light: #333;
      --gray: #666;
      --card-bg: rgba(255, 255, 255, 0.8);
      --card-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    
    .vip-badge {
      background: linear-gradient(90deg, #ffd700, #ff8c00);
      color: black;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-left: 5px;
      display: inline-block;
    }
    
    .news-card {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: left;
      transition: all 0.3s;
    }
    
    .news-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .news-date {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 5px;
    }
    
    .news-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .news-content {
      font-size: 0.9rem;
    }
    
    .floating-action-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 5px 15px rgba(255, 0, 128, 0.4);
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s;
    }
    
    .floating-action-btn:hover {
      transform: scale(1.1) translateY(-5px);
      box-shadow: 0 8px 20px rgba(255, 0, 128, 0.6);
    }
    
    .floating-action-btn:active {
      transform: scale(0.95);
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: var(--accent);
      opacity: 0;
      z-index: 9999;
      animation: confetti 3s ease-out;
    }
    
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    
    /* Mobile Taskbar */
    .mobile-taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 99;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .taskbar-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--light);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s;
      padding: 5px 10px;
      border-radius: 8px;
    }
    
    .taskbar-item i {
      font-size: 1.2rem;
      margin-bottom: 3px;
    }
    
    .taskbar-item.active {
      color: var(--accent);
      background: rgba(255,255,255,0.1);
    }
    
    .taskbar-item:hover {
      transform: translateY(-3px);
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 15px;
        margin-bottom: 70px; /* Space for taskbar */
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      button {
        padding: 12px 20px;
      }
      
      .rubies {
        font-size: 1.8rem;
      }
      
      .stat-box {
        padding: 12px 8px;
        font-size: 0.8rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .floating-action-btn {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
        bottom: 80px; /* Above taskbar */
      }
      
      .mobile-taskbar {
        padding: 8px 0;
      }
      
      .taskbar-item {
        font-size: 0.7rem;
        padding: 5px 8px;
      }
      
      .taskbar-item i {
        font-size: 1rem;
      }
      
      .modal-content {
        padding: 15px;
        margin-bottom: 70px;
      }
      
      .user-profile {
        padding: 8px;
      }
      
      .profile-avatar {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }
      
      .profile-name {
        font-size: 1rem;
      }
      
      .profile-level {
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <div id="notification"><i class="fas fa-bell"></i> New notification!</div>

  <div class="container">
    <button id="logoutBtn" onclick="logout()" style="display:none;"><i class="fas fa-sign-out-alt"></i> Logout</button>
    <h1><i class="fas fa-gem"></i> Rubrox Miner</h1>
    <div id="authSection">
      <div class="user-profile" style="justify-content: center; background: none;">
        <div class="profile-avatar">?</div>
        <div class="profile-info">
          <div class="profile-name">Guest</div>
          <div class="profile-level">Not logged in</div>
        </div>
      </div>
      
      <input type="text" id="usernameInput" placeholder="Your Name" />
      <input type="text" id="referralInput" placeholder="Referral Code (optional)" />
      <br />
      <button onclick="login()"><i class="fas fa-play"></i> Start Mining</button>
      <p class="info">By registering, you agree to our <a href="#" onclick="showTerms()" style="color:var(--secondary);">Terms of Service</a></p>
    </div>

    <div id="mainApp" style="display:none;">
      <div class="user-profile">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <div class="profile-info">
          <div class="profile-name" id="userName">User</div>
          <div class="profile-level">Level <span id="userLevel">1</span> Miner</div>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Rubies</div>
          <div class="stat-value"><i class="fas fa-gem"></i> <span id="rubyCount">0</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Mining Days</div>
          <div class="stat-value"><i class="fas fa-calendar-alt"></i> <span id="miningDays">0</span></div>
        </div>
      </div>
      
      <div class="mining-animation" id="miningAnimation" style="display:none;">
        <div class="rock">ü™®</div>
        <div class="pickaxe">‚õèÔ∏è</div>
        <div class="sparkle" style="top:20px; left:60px;">‚ú®</div>
        <div class="sparkle" style="top:40px; left:40px;">‚ú®</div>
        <div class="sparkle" style="top:30px; left:80px;">‚ú®</div>
      </div>
      
      <p class="info" id="miningStatus"></p>
      <div class="progress-container" id="progressContainer" style="display:none;">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <button id="mineBtn" onclick="startMining()"><i class="fas fa-hammer"></i> Start 24h Mining</button>
      <button onclick="claimBonus()" id="bonusBtn"><i class="fas fa-gift"></i> Claim Daily Bonus</button>
      <p class="info" id="bonusStatus"></p>
      <p class="info" id="kycStatus"></p>
      
      <div class="badge-container">
        <div class="badge" id="kycBadge"><i class="fas fa-id-card"></i> KYC</div>
        <div class="badge" id="vipBadge" style="display:none;"><i class="fas fa-crown"></i> VIP</div>
        <div class="badge" id="refBadge"><i class="fas fa-users"></i> Referrals</div>
      </div>
      
      <button onclick="requestWithdraw()" id="withdrawBtn" disabled><i class="fas fa-money-bill-wave"></i> Request Withdraw</button>
      
      <div class="tab-container">
        <div class="tab active" onclick="switchTab('leaderboard')"><i class="fas fa-trophy"></i> Leaderboard</div>
        <div class="tab" onclick="switchTab('referrals')"><i class="fas fa-users"></i> Referrals</div>
        <div class="tab" onclick="switchTab('withdrawals')"><i class="fas fa-wallet"></i> Wallet</div>
      </div>
      
      <div id="leaderboard" class="tab-content active"></div>
      
      <div id="referrals" class="tab-content">
        <h3><i class="fas fa-link"></i> Your Referral Link</h3>
        <div class="referral-link" id="referralLink">Loading...</div>
        <button onclick="copyReferralLink()"><i class="fas fa-copy"></i> Copy Link</button>
        
        <div class="referral-stats">
          <div class="stat-box">
            <div><i class="fas fa-users"></i> Total Referrals</div>
            <div id="totalReferrals">0</div>
          </div>
          <div class="stat-box">
            <div><i class="fas fa-coins"></i> Referral Earnings</div>
            <div id="referralEarnings">0 <i class="fas fa-gem"></i></div>
          </div>
        </div>
        
        <h3><i class="fas fa-user-plus"></i> Your Referrals</h3>
        <div id="referralList"></div>
      </div>
      
      <div id="withdrawals" class="tab-content">
        <h3><i class="fas fa-history"></i> Withdrawal History</h3>
        <div id="withdrawalHistory"></div>
        
        <h3><i class="fas fa-wallet"></i> Wallet Settings</h3>
        <input type="text" id="walletAddress" placeholder="Enter your crypto wallet address" />
        <select id="walletType">
          <option value="btc">Bitcoin (BTC)</option>
          <option value="eth">Ethereum (ETH)</option>
          <option value="usdt">USDT (TRC20)</option>
          <option value="other">Other</option>
        </select>
        <button onclick="saveWallet()"><i class="fas fa-save"></i> Save Wallet</button>
      </div>
    </div>
  </div>

  <!-- Mobile Taskbar -->
  <div class="mobile-taskbar" id="mobileTaskbar" style="display:none;">
    <div class="taskbar-item active" onclick="switchTab('leaderboard')">
      <i class="fas fa-trophy"></i>
      <span>Leaderboard</span>
    </div>
    <div class="taskbar-item" onclick="switchTab('referrals')">
      <i class="fas fa-users"></i>
      <span>Referrals</span>
    </div>
    <div class="taskbar-item" onclick="switchTab('withdrawals')">
      <i class="fas fa-wallet"></i>
      <span>Wallet</span>
    </div>
    <div class="taskbar-item" onclick="showSettings()">
      <i class="fas fa-cog"></i>
      <span>Settings</span>
    </div>
  </div>

  <div id="banScreen" class="ban-screen" style="display:none;">
    <h2><i class="fas fa-ban"></i> ACCOUNT BANNED</h2>
    <p>Your account has been suspended by the administrator.</p>
    <p>Please contact support if you believe this is a mistake.</p>
    <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Return to Login</button>
  </div>

  <!-- KYC Verification Modal -->
  <div id="kycModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('kycModal')">&times;</span>
      <h2><i class="fas fa-id-card"></i> KYC Verification</h2>
      <p>To withdraw your rubies, please complete KYC verification by providing the following information:</p>
      
      <div class="kyc-form">
        <label>Full Name</label>
        <input type="text" id="kycName" placeholder="As per your ID">
        
        <label>Date of Birth</label>
        <input type="date" id="kycDob">
        
        <label>ID Type</label>
        <select id="kycIdType">
          <option value="passport">Passport</option>
          <option value="driver_license">Driver's License</option>
          <option value="national_id">National ID</option>
        </select>
        
        <label>ID Number</label>
        <input type="text" id="kycIdNumber" placeholder="ID document number">
        
        <label>ID Photo (Front)</label>
        <div class="kyc-upload" onclick="document.getElementById('kycFront').click()">
          <p><i class="fas fa-camera"></i> Click to upload ID Front</p>
          <input type="file" id="kycFront" accept="image/*" style="display:none;" onchange="previewImage(this, 'kycFrontPreview')">
          <img id="kycFrontPreview" style="max-width:100%; max-height:150px; display:none;">
        </div>
        
        <label>ID Photo (Back)</label>
        <div class="kyc-upload" onclick="document.getElementById('kycBack').click()">
          <p><i class="fas fa-camera"></i> Click to upload ID Back</p>
          <input type="file" id="kycBack" accept="image/*" style="display:none;" onchange="previewImage(this, 'kycBackPreview')">
          <img id="kycBackPreview" style="max-width:100%; max-height:150px; display:none;">
        </div>
        
        <label>Selfie with ID</label>
        <div class="kyc-upload" onclick="document.getElementById('kycSelfie').click()">
          <p><i class="fas fa-user"></i> Click to upload Selfie with ID</p>
          <input type="file" id="kycSelfie" accept="image/*" style="display:none;" onchange="previewImage(this, 'kycSelfiePreview')">
          <img id="kycSelfiePreview" style="max-width:100%; max-height:150px; display:none;">
        </div>
        
        <button onclick="submitKYC()"><i class="fas fa-check"></i> Submit Verification</button>
      </div>
    </div>
  </div>

  <!-- Terms Modal -->
  <div id="termsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('termsModal')">&times;</span>
      <h2><i class="fas fa-file-contract"></i> Terms of Service</h2>
      <div style="text-align:left; max-height:60vh; overflow-y:auto;">
        <h3>1. Account Terms</h3>
        <p>You must be at least 18 years old to use this service. You are responsible for maintaining the security of your account.</p>
        
        <h3>2. Mining Rules</h3>
        <p>Each mining session lasts 24 hours. You can only have one active mining session at a time. The mining rate is approximately 0.0002 rubies every 5 seconds.</p>
        
        <h3>3. Referral Program</h3>
        <p>You earn 5 rubies for each successful referral, and your referral earns 10 rubies. Referral bonuses are awarded only when the referred user completes their first mining session.</p>
        
        <h3>4. Withdrawals</h3>
        <p>Withdrawals require KYC verification after 30 days of mining. Withdrawal requests are processed within 3-5 business days. There may be minimum withdrawal amounts.</p>
        
        <h3>5. Prohibited Activities</h3>
        <p>The following activities are prohibited and may result in account suspension:</p>
        <ul>
          <li>Creating multiple accounts</li>
          <li>Using automated scripts or bots</li>
          <li>Attempting to exploit system vulnerabilities</li>
          <li>Providing false information during KYC</li>
        </ul>
        
        <h3>6. VIP Program</h3>
        <p>VIP members earn 50% more rubies and get priority withdrawals. Upgrade to VIP by inviting 10 active referrals.</p>
        
        <h3>7. Liability</h3>
        <p>We are not responsible for any losses resulting from unauthorized access to your account. Ruby values may fluctuate.</p>
      </div>
      <button onclick="closeModal('termsModal')"><i class="fas fa-check"></i> I Understand</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('settingsModal')">&times;</span>
      <h2><i class="fas fa-cog"></i> Settings</h2>
      
      <div class="settings-item">
        <div>
          <i class="fas fa-moon"></i> Dark Mode
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="darkModeToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-item">
        <div>
          <i class="fas fa-bell"></i> Notifications
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="notificationsToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-item">
        <div>
          <i class="fas fa-vibrate"></i> Haptic Feedback
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="hapticToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <h3 style="margin-top:20px;"><i class="fas fa-info-circle"></i> About</h3>
      <p style="text-align:left; margin:10px 0;">Rubrox Miner v2.0.1</p>
      <p style="text-align:left; margin:10px 0;">¬© 2023 Rubrox Mining. All rights reserved.</p>
      
      <button onclick="showSupport()"><i class="fas fa-headset"></i> Contact Support</button>
    </div>
  </div>

  <!-- News Modal -->
  <div id="newsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('newsModal')">&times;</span>
      <h2><i class="fas fa-newspaper"></i> Latest News</h2>
      
      <div class="news-card">
        <div class="news-date">June 15, 2023</div>
        <div class="news-title">New VIP Program Launched!</div>
        <div class="news-content">We're excited to announce our new VIP program. Invite 10 active referrals to become a VIP and earn 50% more rubies!</div>
      </div>
      
      <div class="news-card">
        <div class="news-date">June 1, 2023</div>
        <div class="news-title">Withdrawal Processing Times Improved</div>
        <div class="news-content">We've upgraded our systems and now process withdrawals within 24-48 hours for verified accounts.</div>
      </div>
      
      <div class="news-card">
        <div class="news-date">May 20, 2023</div>
        <div class="news-title">New Mobile App Coming Soon</div>
        <div class="news-content">Our native mobile app is in development and will be released next month with push notifications and more features.</div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <div class="floating-action-btn" onclick="showSettings()">
    <i class="fas fa-cog"></i>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDX7Z8o5xVJa8cSHvaurZg4FkJvN8mJuto",
      authDomain: "free-fire-kingdom.firebaseapp.com",
      databaseURL: "https://free-fire-kingdom-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "free-fire-kingdom",
      storageBucket: "free-fire-kingdom.appspot.com",
      messagingSenderId: "889375613179",
      appId: "1:889375613179:web:b36bd72dd208b101e0d05e",
      measurementId: "G-0EWSZ3SFX1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "";
    let miningInterval;
    let progressInterval;
    let referralLink = "";
    let isVip = false;

    // New Feature 1: Dark/Light Mode Toggle
    function toggleDarkMode() {
      document.body.classList.toggle('light-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    }

    // New Feature 2: Haptic Feedback
    function vibrate() {
      if ('vibrate' in navigator && document.getElementById('hapticToggle').checked) {
        navigator.vibrate(50);
      }
    }

    // New Feature 3: Confetti Effect
    function showConfetti() {
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      });
    }

    // New Feature 4: User Level System
    function calculateLevel(miningDays) {
      return Math.floor(miningDays / 10) + 1;
    }

    // New Feature 5: VIP Status Check
    function checkVipStatus(totalReferrals) {
      isVip = totalReferrals >= 10;
      document.getElementById('vipBadge').style.display = isVip ? 'flex' : 'none';
      return isVip;
    }

    // New Feature 6: Wallet Address Management
    function saveWallet() {
      const address = document.getElementById('walletAddress').value.trim();
      const type = document.getElementById('walletType').value;
      
      if (!address) {
        showNotification('Please enter a wallet address');
        return;
      }
      
      db.ref("users/" + currentUser + "/wallet").set({
        address: address,
        type: type,
        updatedAt: new Date().toISOString()
      });
      
      showNotification('Wallet address saved successfully!');
    }

    // New Feature 7: Support Contact
    function showSupport() {
      closeModal('settingsModal');
      showModal('newsModal');
    }

    // New Feature 8: Settings Panel
    function showSettings() {
      showModal('settingsModal');
    }

    // New Feature 9: Mining Animation
    function toggleMiningAnimation(show) {
      document.getElementById('miningAnimation').style.display = show ? 'flex' : 'none';
    }

    // New Feature 10: Profile Avatar
    function updateProfileAvatar(name) {
      const avatar = document.getElementById('profileAvatar');
      if (name && name.length > 0) {
        avatar.textContent = name.charAt(0).toUpperCase();
      }
    }

    function showNotification(message) {
      vibrate();
      const notif = document.getElementById("notification");
      notif.innerHTML = `<i class="fas fa-bell"></i> ${message}`;
      notif.classList.add("show");
      setTimeout(() => {
        notif.classList.remove("show");
      }, 5000);
    }

    function showModal(modalId) {
      vibrate();
      document.getElementById(modalId).style.display = "flex";
    }

    function closeModal(modalId) {
      vibrate();
      document.getElementById(modalId).style.display = "none";
    }

    function showTerms() {
      showModal('termsModal');
    }

    function switchTab(tabId) {
      vibrate();
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
      
      // Update mobile taskbar active state
      document.querySelectorAll('.taskbar-item').forEach(item => {
        item.classList.remove('active');
      });
      const activeTabButton = document.querySelector(`.taskbar-item[onclick="switchTab('${tabId}')"]`);
      if (activeTabButton) {
        activeTabButton.classList.add('active');
      }
      
      if(tabId === 'referrals') {
        loadReferralData();
      } else if(tabId === 'withdrawals') {
        loadWithdrawalHistory();
        loadWalletInfo();
      }
    }

    function login() {
      const name = document.getElementById("usernameInput").value.trim();
      const refCode = document.getElementById("referralInput").value.trim();
      if (!name) return showNotification("Please enter your name");
      currentUser = name;
      localStorage.setItem('currentUser', currentUser); // Save user to localStorage
      updateProfileAvatar(name);
      const userRef = db.ref("users/" + currentUser);

      userRef.once("value", (snap) => {
        if (!snap.exists()) {
          userRef.set({ 
            rubies: 0, 
            referral: refCode || "", 
            miningDays: 0, 
            lastBonus: "", 
            miningEnd: 0, 
            kyc: false, 
            kycRequested: false, 
            banned: false,
            totalReferrals: 0,
            referralEarnings: 0,
            joinDate: new Date().toISOString(),
            level: 1,
            isVip: false
          });
          if (refCode) {
            db.ref("users/" + refCode + "/totalReferrals").transaction(val => (val || 0) + 1);
            showNotification("üéâ Referral link applied! Bonus will be awarded after your first mining session.");
          }
        } else {
          if (refCode && !snap.val().referral) {
            userRef.update({ referral: refCode });
            db.ref("users/" + refCode + "/totalReferrals").transaction(val => (val || 0) + 1);
            showNotification("üéâ Referral link applied! Bonus will be awarded after your first mining session.");
          }
        }
        loadUser();
      });
    }

    function loadUser() {
      document.getElementById("authSection").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      document.getElementById("logoutBtn").style.display = "block";
      document.getElementById("mobileTaskbar").style.display = "flex";
      document.getElementById("userName").innerText = currentUser;

      const ref = db.ref("users/" + currentUser);
      ref.on("value", snap => {
        const data = snap.val();
        if(!data) return;

        if(data.banned) {
          showBanScreen();
          return;
        }

        document.getElementById("rubyCount").innerText = Number(data.rubies).toFixed(4);
        document.getElementById("miningDays").innerText = data.miningDays || 0;
        
        // Update user level
        const level = calculateLevel(data.miningDays || 0);
        document.getElementById("userLevel").textContent = level;
        
        // Check VIP status
        checkVipStatus(data.totalReferrals || 0);

        // Generate referral link
        referralLink = window.location.href.split('?')[0] + '?ref=' + currentUser;
        document.getElementById("referralLink").textContent = referralLink;

        const now = Date.now();
        const today = new Date().toISOString().slice(0, 10);

        // Check if bonus already claimed today
        if (data.lastBonus === today) {
          document.getElementById("bonusStatus").innerText = "üéÅ Daily bonus already claimed! Come back tomorrow.";
          document.getElementById("bonusBtn").disabled = true;
        } else {
          document.getElementById("bonusStatus").innerText = "üéÅ Daily bonus available!";
          document.getElementById("bonusBtn").disabled = false;
        }

        if (data.miningEnd && data.miningEnd > now) {
          document.getElementById("mineBtn").disabled = true;
          document.getElementById("progressContainer").style.display = "block";
          const remaining = data.miningEnd - now;
          updateProgressBar(remaining);
          document.getElementById("miningStatus").innerText = "‚õèÔ∏è Mining active - " + formatTime(remaining);
          startMiningInterval(data.miningEnd);
          startProgressInterval(data.miningEnd);
          toggleMiningAnimation(true);
        } else {
          document.getElementById("mineBtn").disabled = false;
          document.getElementById("progressContainer").style.display = "none";
          document.getElementById("miningStatus").innerText = "üïí Ready to start mining";
          if (miningInterval) {
            clearInterval(miningInterval);
          }
          if (progressInterval) {
            clearInterval(progressInterval);
          }
          toggleMiningAnimation(false);
        }

        if (data.kycRequested) {
          document.getElementById("kycStatus").innerHTML = data.kyc ? 
            '<span class="success">‚úÖ KYC Verified</span>' : 
            '<span class="warning">‚åõ KYC Pending (admin approval required)</span>';
          document.getElementById("kycBadge").innerHTML = data.kyc ? 
            '<i class="fas fa-check-circle"></i> KYC Verified' : 
            '<i class="fas fa-clock"></i> KYC Pending';
        } else if (data.miningDays >= 30) {
          document.getElementById("kycStatus").innerHTML = 
            '<span class="success">üéâ You\'re eligible for KYC verification! <a href="#" onclick="showModal(\'kycModal\')" style="color:var(--secondary);">Click here</a> to verify</span>';
          document.getElementById("kycBadge").innerHTML = '<i class="fas fa-id-card"></i> KYC Ready';
        } else {
          const daysLeft = 30 - (data.miningDays || 0);
          document.getElementById("kycStatus").innerHTML = 
            `<span class="info">üìÜ ${daysLeft} more mining days to unlock KYC</span>`;
          document.getElementById("kycBadge").innerHTML = '<i class="fas fa-lock"></i> KYC Locked';
        }

        document.getElementById("withdrawBtn").disabled = !data.kyc;
      });

      loadLeaderboard();
    }

    function loadWalletInfo() {
      db.ref("users/" + currentUser + "/wallet").once("value").then(snap => {
        if (snap.exists()) {
          const wallet = snap.val();
          document.getElementById("walletAddress").value = wallet.address || "";
          document.getElementById("walletType").value = wallet.type || "btc";
        }
      });
    }

    function showBanScreen() {
      document.getElementById("banScreen").style.display = "flex";
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("authSection").style.display = "none";
      document.getElementById("mobileTaskbar").style.display = "none";
    }

    function formatTime(ms) {
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);
      return `${hours}h ${minutes}m ${seconds}s remaining`;
    }

    function updateProgressBar(remaining) {
      const total = 24 * 60 * 60 * 1000;
      const percentage = 100 - (remaining / total * 100);
      document.getElementById("progressBar").style.width = `${percentage}%`;
    }

    function startProgressInterval(endTime) {
      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now;
        if (remaining <= 0) {
          clearInterval(progressInterval);
          document.getElementById("progressContainer").style.display = "none";
          return;
        }
        updateProgressBar(remaining);
        document.getElementById("miningStatus").innerText = "‚õèÔ∏è Mining active - " + formatTime(remaining);
      }, 1000);
    }

    function startMiningInterval(endTime) {
      if (miningInterval) clearInterval(miningInterval);
      miningInterval = setInterval(() => {
        const now = Date.now();
        if (now >= endTime) {
          clearInterval(miningInterval);
          document.getElementById("mineBtn").disabled = false;
          document.getElementById("progressContainer").style.display = "none";
          document.getElementById("miningStatus").innerText = "‚úÖ Mining finished! Start again to earn more";
          showNotification("‚õèÔ∏è Your mining session has completed!");
          toggleMiningAnimation(false);
          
          // Award referral bonus if this was first mining session
          const userRef = db.ref("users/" + currentUser);
          userRef.once("value").then(snap => {
            const data = snap.val();
            if (data.referral && data.miningDays === 1) {
              // Give bonus to referrer
              db.ref("users/" + data.referral + "/rubies").transaction(val => (val || 0) + 10);
              db.ref("users/" + data.referral + "/referralEarnings").transaction(val => (val || 0) + 10);
              // Give bonus to new user
              userRef.child("rubies").transaction(val => (val || 0) + 5);
              showNotification("üéâ Referral bonus awarded! +5 Rubies for you and +10 for your referrer");
            }
            
            // Check for VIP status
            if (data.totalReferrals >= 10 && !data.isVip) {
              userRef.update({ isVip: true });
              showNotification("üéâ Congratulations! You've unlocked VIP status!");
              showConfetti();
            }
          });
          return;
        }
        
        // VIP users earn 50% more
        const earnings = isVip ? 0.0003 : 0.0002;
        db.ref("users/" + currentUser + "/rubies").transaction(rubies => (rubies || 0) + earnings);
      }, 5000);
    }

    function startMining() {
      vibrate();
      const now = Date.now();
      const end = now + 24 * 60 * 60 * 1000;
      const userRef = db.ref("users/" + currentUser);

      userRef.once("value").then(snap => {
        const data = snap.val();
        if (!data.miningEnd || data.miningEnd < now) {
          userRef.update({
            miningEnd: end,
            miningDays: (data.miningDays || 0) + 1,
            level: calculateLevel((data.miningDays || 0) + 1)
          });
          startMiningInterval(end);
          startProgressInterval(end);
          document.getElementById("mineBtn").disabled = true;
          document.getElementById("progressContainer").style.display = "block";
          document.getElementById("miningStatus").innerText = "‚õèÔ∏è Mining active - " + formatTime(24 * 60 * 60 * 1000);
          showNotification("‚õèÔ∏è Mining started for 24 hours!");
          toggleMiningAnimation(true);
        } else {
          showNotification("Mining is already active");
        }
      });
    }

    function claimBonus() {
      vibrate();
      const today = new Date().toISOString().slice(0, 10);
      const userRef = db.ref("users/" + currentUser);
      userRef.once("value").then(snap => {
        const data = snap.val();
        if (data.lastBonus === today) {
          document.getElementById("bonusStatus").innerText = "üéÅ Daily bonus already claimed!";
          showNotification("You've already claimed your daily bonus today");
        } else {
          // VIP users get bigger bonus
          const bonus = isVip ? 30 : 20;
          userRef.update({
            rubies: (data.rubies || 0) + bonus,
            lastBonus: today
          });
          document.getElementById("bonusStatus").innerText = `‚úÖ Daily bonus claimed! +${bonus} Rubies`;
          document.getElementById("bonusBtn").disabled = true;
          showNotification(`üéÅ Daily bonus claimed! +${bonus} Rubies`);
          showConfetti();
        }
      });
    }

    function requestWithdraw() {
      vibrate();
      const userRef = db.ref("users/" + currentUser);
      userRef.once("value").then(snap => {
        const data = snap.val();
        const balance = data.rubies || 0;
        
        const amount = prompt(`Enter withdraw amount (Available: ${balance.toFixed(4)} Rubies, Minimum: 100 Rubies):`);
        if (!amount || isNaN(amount)) return showNotification("Invalid amount");
        
        if (parseFloat(amount) > balance) {
          return showNotification("Insufficient balance");
        }
        
        if (parseFloat(amount) < 100) {
          return showNotification("Minimum withdrawal amount is 100 Rubies");
        }
        
        const contact = prompt("Enter contact info (e.g., phone number or email):");
        if (!contact) return showNotification("Contact info required");
        
        const reqRef = db.ref("withdrawals").push();
        reqRef.set({
          user: currentUser,
          amount: parseFloat(amount),
          contact: contact,
          status: "pending",
          timestamp: Date.now(),
          processed: false,
          isVip: isVip // VIP withdrawals get priority
        });
        
        // Deduct from balance
        userRef.child("rubies").transaction(rubies => (rubies || 0) - parseFloat(amount));
        
        showNotification("‚úÖ Withdrawal request submitted! Processing may take 3-5 business days.");
        showConfetti();
      });
    }

    function loadLeaderboard() {
      db.ref("users").orderByChild("rubies").limitToLast(10).on("value", snap => {
        const list = [];
        snap.forEach(child => {
          const d = child.val();
          if(d.banned) return;
          list.push({ name: child.key, rubies: d.rubies || 0, isVip: d.isVip || false });
        });
        
        // Reverse to show highest first
        list.reverse();
        const leaderboard = document.getElementById("leaderboard");
        leaderboard.innerHTML = "";
        
        list.forEach((u, index) => {
          const item = document.createElement("div");
          item.className = "leaderboard-item";
          
          const rank = document.createElement("span");
          rank.className = "leaderboard-rank";
          rank.textContent = `#${index + 1}`;
          
          const name = document.createElement("span");
          name.className = "leaderboard-name";
          name.textContent = u.name;
          if (u.isVip) {
            name.innerHTML += `<span class="vip-badge">VIP</span>`;
          }
          
          const rubies = document.createElement("span");
          rubies.className = "leaderboard-rubies";
          rubies.innerHTML = `${u.rubies.toFixed(4)} <i class="fas fa-gem"></i>`;
          
          item.appendChild(rank);
          item.appendChild(name);
          item.appendChild(rubies);
          leaderboard.appendChild(item);
        });
      });
    }

    function loadReferralData() {
      // Load referral stats
      db.ref("users/" + currentUser).once("value").then(snap => {
        const data = snap.val();
        document.getElementById("totalReferrals").textContent = data.totalReferrals || 0;
        document.getElementById("referralEarnings").innerHTML = (data.referralEarnings || 0) + ' <i class="fas fa-gem"></i>';
        checkVipStatus(data.totalReferrals || 0);
      });
      
      // Load referral list
      db.ref("users").orderByChild("referral").equalTo(currentUser).once("value").then(snap => {
        const referralList = document.getElementById("referralList");
        referralList.innerHTML = "";
        
        if (!snap.exists()) {
          referralList.innerHTML = "<p>No referrals yet</p>";
          return;
        }
        
        snap.forEach(child => {
          const item = document.createElement("div");
          item.className = "leaderboard-item";
          item.innerHTML = `
            <span>${child.key}</span>
            <span>Joined: ${new Date(child.val().joinDate).toLocaleDateString()}</span>
          `;
          referralList.appendChild(item);
        });
      });
    }

    function loadWithdrawalHistory() {
      db.ref("withdrawals").orderByChild("user").equalTo(currentUser).once("value").then(snap => {
        const history = document.getElementById("withdrawalHistory");
        history.innerHTML = "";
        
        if (!snap.exists()) {
          history.innerHTML = "<p>No withdrawal history</p>";
          return;
        }
        
        const withdrawals = [];
        snap.forEach(child => {
          withdrawals.push({
            key: child.key,
            ...child.val()
          });
        });
        
        // Sort by timestamp (newest first)
        withdrawals.sort((a, b) => b.timestamp - a.timestamp);
        
        withdrawals.forEach(w => {
          const item = document.createElement("div");
          item.className = "withdrawal-item";
          item.innerHTML = `
            <div><strong>Amount:</strong> ${w.amount.toFixed(4)} üíé</div>
            <div><strong>Date:</strong> ${new Date(w.timestamp).toLocaleString()}</div>
            <div><strong>Status:</strong> <span class="withdrawal-status status-${w.status}">${w.status.toUpperCase()} ${w.isVip ? ' (VIP)' : ''}</span></div>
          `;
          history.appendChild(item);
        });
      });
    }

    function copyReferralLink() {
      vibrate();
      navigator.clipboard.writeText(referralLink).then(() => {
        showNotification("Referral link copied to clipboard!");
      }).catch(err => {
        console.error("Failed to copy: ", err);
        showNotification("Failed to copy link");
      });
    }

    function previewImage(input, previewId) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById(previewId);
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    }

    function submitKYC() {
      vibrate();
      const name = document.getElementById("kycName").value.trim();
      const dob = document.getElementById("kycDob").value;
      const idType = document.getElementById("kycIdType").value;
      const idNumber = document.getElementById("kycIdNumber").value.trim();
      
      if (!name || !dob || !idNumber) {
        return showNotification("Please fill all required fields");
      }
      
      const userRef = db.ref("users/" + currentUser);
      userRef.update({
        kycRequested: true,
        kycData: {
          name: name,
          dob: dob,
          idType: idType,
          idNumber: idNumber,
          submittedAt: new Date().toISOString()
        }
      });
      
      db.ref("kycSubmissions").push().set({
        user: currentUser,
        submittedAt: new Date().toISOString(),
        status: "pending"
      });
      
      showNotification("‚úÖ KYC submitted for review! Please wait for admin approval.");
      closeModal('kycModal');
    }

    // Check for referral code on page load
    window.onload = function() {
      // Load dark mode preference
      if (localStorage.getItem('darkMode') === 'light') {
        document.body.classList.add('light-mode');
        document.getElementById('darkModeToggle').checked = false;
      }
      
      // Set up toggle switches
      document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
      
      const urlParams = new URLSearchParams(window.location.search);
      const refCode = urlParams.get('ref');
      if (refCode) {
        document.getElementById("referralInput").value = refCode;
      }
      
      // Check if user is already logged in
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = savedUser;
        loadUser();
      }
      
      // Global notifications
      db.ref("notifications").limitToLast(1).on("child_added", snap => {
        const notif = snap.val();
        showNotification("üîî " + notif.message);
      });
    };

    function logout() {
      vibrate();
      if(miningInterval) clearInterval(miningInterval);
      if(progressInterval) clearInterval(progressInterval);
      currentUser = "";
      localStorage.removeItem('currentUser');
      document.getElementById("authSection").style.display = "block";
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("mobileTaskbar").style.display = "none";
      document.getElementById("banScreen").style.display = "none";
      document.getElementById("usernameInput").value = "";
      document.getElementById("referralInput").value = "";
      document.getElementById("bonusStatus").innerText = "";
      document.getElementById("kycStatus").innerText = "";
      document.getElementById("miningStatus").innerText = "";
      document.getElementById("progressContainer").style.display = "none";
      toggleMiningAnimation(false);
    }
  </script>
</body>
</html>
